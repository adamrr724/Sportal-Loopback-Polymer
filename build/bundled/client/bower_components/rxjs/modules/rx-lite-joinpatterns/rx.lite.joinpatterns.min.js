(function(e){function t(e){return e&&e.Object===Object?e:null}var n={"function":!0,object:!0},r=n[typeof exports]&&exports&&!exports.nodeType?exports:null,i=n[typeof module]&&module&&!module.nodeType?module:null,s=t(r&&i&&"object"==typeof global&&global),o=t(n[typeof self]&&self),u=t(n[typeof window]&&window),h=(i&&i.exports===r?r:null,t(n[typeof this]&&this)),a=s||u!==(h&&h.window)&&u||o||h||Function("return this")();"function"==typeof define&&define.amd?define(["./rx.lite"],function(t,n){return e(a,n,t)}):"object"==typeof module&&module&&module.exports===r?module.exports=e(a,module.exports,require("rx-lite")):a.Rx=e(a,{},a.Rx)}).call(this,function(e,t,n,r){function i(e){return function(){try{return e.apply(this,arguments)}catch(t){return g.e=t,g}}}function s(e){this.patterns=e}function o(e,t){this.expression=e,this.selector=t}function u(e){return function(t){e.onError(t)}}function h(e,t){return function(){var n=A(e.selector).apply(e,arguments);return n===g?t.onError(n.e):void t.onNext(n)}}function a(e,t,n){var r=e.get(t);if(!r){var i=new E(t,n);return e.set(t,i),i}return r}function c(e,t,n){this.joinObserverArray=e,this.onNext=t,this.onCompleted=n,this.joinObservers=new j;for(var r=0,i=this.joinObserverArray.length;i>r;r++){var s=this.joinObserverArray[r];this.joinObservers.set(s,s)}}var l=n.Observable,p=l.prototype,f=n.AnonymousObservable,v=l.throwError,d=n.Observer.create,y=n.SingleAssignmentDisposable,b=n.CompositeDisposable,x=n.internals.AbstractObserver,m=n.helpers.noop,w=n.internals.inherits,O=n.helpers.isFunction,g={e:{}},A=n.internals.tryCatch=function(e){if(!O(e))throw new TypeError("fn must be a function");return i(e)},j=e.Map||function(){function e(){this.size=0,this._values=[],this._keys=[]}return e.prototype["delete"]=function(e){var t=this._keys.indexOf(e);return-1===t?!1:(this._values.splice(t,1),this._keys.splice(t,1),this.size--,!0)},e.prototype.get=function(e){var t=this._keys.indexOf(e);return-1===t?r:this._values[t]},e.prototype.set=function(e,t){var n=this._keys.indexOf(e);return-1===n?(this._keys.push(e),this._values.push(t),this.size++):this._values[n]=t,this},e.prototype.forEach=function(e,t){for(var n=0;n<this.size;n++)e.call(t,this._values[n],this._keys[n])},e}();s.prototype.and=function(e){return new s(this.patterns.concat(e))},s.prototype.thenDo=function(e){return new o(this,e)},o.prototype.activate=function(e,t,n){for(var r=[],i=u(t),s=0,o=this.expression.patterns.length;o>s;s++)r.push(a(e,this.expression.patterns[s],i));var l=new c(r,h(this,t),function(){for(var e=0,t=r.length;t>e;e++)r[e].removeActivePlan(l);n(l)});for(s=0,o=r.length;o>s;s++)r[s].addActivePlan(l);return l},c.prototype.dequeue=function(){this.joinObservers.forEach(function(e){e.queue.shift()})},c.prototype.match=function(){var e,t,n=!0;for(e=0,t=this.joinObserverArray.length;t>e;e++)if(0===this.joinObserverArray[e].queue.length){n=!1;break}if(n){var r=[],i=!1;for(e=0,t=this.joinObserverArray.length;t>e;e++)r.push(this.joinObserverArray[e].queue[0]),"C"===this.joinObserverArray[e].queue[0].kind&&(i=!0);if(i)this.onCompleted();else{this.dequeue();var s=[];for(e=0,t=r.length;e<r.length;e++)s.push(r[e].value);this.onNext.apply(this,s)}}};var E=function(e){function t(t,n){e.call(this),this.source=t,this.onError=n,this.queue=[],this.activePlans=[],this.subscription=new y,this.isDisposed=!1}w(t,e);var n=t.prototype;return n.next=function(e){if(!this.isDisposed){if("E"===e.kind)return this.onError(e.error);this.queue.push(e);for(var t=this.activePlans.slice(0),n=0,r=t.length;r>n;n++)t[n].match()}},n.error=m,n.completed=m,n.addActivePlan=function(e){this.activePlans.push(e)},n.subscribe=function(){this.subscription.setDisposable(this.source.materialize().subscribe(this))},n.removeActivePlan=function(e){this.activePlans.splice(this.activePlans.indexOf(e),1),0===this.activePlans.length&&this.dispose()},n.dispose=function(){e.prototype.dispose.call(this),this.isDisposed||(this.isDisposed=!0,this.subscription.dispose())},t}(x);return p.and=function(e){return new s([this,e])},p.thenDo=function(e){return new s([this]).thenDo(e)},l.when=function(){var e,t=arguments.length;if(Array.isArray(arguments[0]))e=arguments[0];else{e=new Array(t);for(var n=0;t>n;n++)e[n]=arguments[n]}return new f(function(t){var n=[],r=new j,i=d(function(e){t.onNext(e)},function(e){r.forEach(function(t){t.onError(e)}),t.onError(e)},function(e){t.onCompleted()});try{for(var s=0,o=e.length;o>s;s++)n.push(e[s].activate(r,i,function(e){var r=n.indexOf(e);n.splice(r,1),0===n.length&&t.onCompleted()}))}catch(u){return v(u).subscribe(t)}var h=new b;return r.forEach(function(e){e.subscribe(),h.add(e)}),h})},n});