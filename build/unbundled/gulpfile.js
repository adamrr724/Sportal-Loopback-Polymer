"use strict";require("es6-promise").polyfill();var gulp=require("gulp"),$=require("gulp-load-plugins")(),del=require("del"),runSequence=require("run-sequence").use(gulp),browserSync=require("browser-sync"),reload=browserSync.reload,merge=require("merge-stream"),path=require("path"),fs=require("fs"),glob=require("glob-all"),historyApiFallback=require("connect-history-api-fallback"),packageJson=require("./package.json"),crypto=require("crypto"),ensureFiles=require("./tasks/ensure-files.js"),AUTOPREFIXER_BROWSERS=["ie >= 10","ie_mob >= 10","ff >= 30","chrome >= 34","safari >= 7","opera >= 23","ios >= 7","android >= 4.4","bb >= 10"],DIST="dist",dist=function(e){return e?path.join(DIST,e):DIST},styleTask=function(e,t){return gulp.src(t.map(function(t){return path.join("client",e,t)})).pipe($.changed(e,{extension:".css"})).pipe($.autoprefixer(AUTOPREFIXER_BROWSERS)).pipe(gulp.dest(".tmp/"+e)).pipe($.minifyCss()).pipe(gulp.dest(dist(e))).pipe($.size({title:e}))},imageOptimizeTask=function(e,t){return gulp.src(e).pipe($.imagemin({progressive:!0,interlaced:!0})).pipe(gulp.dest(t)).pipe($.size({title:"images"}))},optimizeHtmlTask=function(e,t){var i=$.useref.assets({searchPath:[".tmp","client"]});return gulp.src(e).pipe(i).pipe($["if"]("*.js",$.uglify({preserveComments:"some"}))).pipe($["if"]("*.css",$.minifyCss())).pipe(i.restore()).pipe($.useref()).pipe($["if"]("*.html",$.minifyHtml({quotes:!0,empty:!0,spare:!0}))).pipe(gulp.dest(t)).pipe($.size({title:"html"}))};gulp.task("styles",function(){return styleTask("styles",["**/*.css"])}),gulp.task("ensureFiles",function(e){var t=[".bowerrc"];ensureFiles(t.map(function(e){return path.join(__dirname,e)}),e)}),gulp.task("images",function(){return imageOptimizeTask("client/images/**/*",dist("images"))}),gulp.task("copy",function(){var e=gulp.src(["client/*","!client/test","!client/elements","!client/bower_components","!client/cache-config.json","!**/.DS_Store"],{dot:!0}).pipe(gulp.dest(dist())),t=gulp.src(["client/bower_components/{webcomponentsjs,platinum-sw,sw-toolbox,promise-polyfill}/**/*"]).pipe(gulp.dest(dist("bower_components")));return merge(e,t).pipe($.size({title:"copy"}))}),gulp.task("fonts",function(){return gulp.src(["client/fonts/**"]).pipe(gulp.dest(dist("fonts"))).pipe($.size({title:"fonts"}))}),gulp.task("html",function(){return optimizeHtmlTask(["client/**/*.html","!client/{elements,test,bower_components}/**/*.html"],dist())}),gulp.task("vulcanize",function(){return gulp.src("client/elements/elements.html").pipe($.vulcanize({stripComments:!0,inlineCss:!0,inlineScripts:!0})).pipe(gulp.dest(dist("elements"))).pipe($.size({title:"vulcanize"}))}),gulp.task("cache-config",function(e){var t=dist(),i={cacheId:packageJson.name||path.basename(__dirname),disabled:!1};glob(["index.html","./","bower_components/webcomponentsjs/webcomponents-lite.min.js","{elements,scripts,styles}/**/*.*"],{cwd:t},function(s,n){if(s)e(s);else{i.precache=n;var r=crypto.createHash("md5");r.update(JSON.stringify(i.precache)),i.precacheFingerprint=r.digest("hex");var p=path.join(t,"cache-config.json");fs.writeFile(p,JSON.stringify(i),e)}})}),gulp.task("clean",function(){return del([".tmp","client/scripts/bundle.js",dist()])}),gulp.task("serve:client",["styles"],function(){browserSync({port:5e3,notify:!1,logPrefix:"PSK",snippetOptions:{rule:{match:'<span id="browser-sync-binding"></span>',fn:function(e){return e}}},server:{baseDir:[".tmp","client"],middleware:[historyApiFallback()]}}),gulp.watch(["client/**/*.html","!client/bower_components/**/*.html"],reload),gulp.watch(["client/styles/**/*.css"],["styles",reload]),gulp.watch(["client/scripts/**/*.js"],reload),gulp.watch(["client/loopback/**/*.js"],["lbclient",reload]),gulp.watch(["client/loopback/**/*.json"],["lbclient",reload]),gulp.watch(["client/images/**/*"],reload)}),gulp.task("serve:dist",["default","serve"],function(){browserSync({port:5001,notify:!1,logPrefix:"PSK",snippetOptions:{rule:{match:'<span id="browser-sync-binding"></span>',fn:function(e){return e}}},server:dist(),middleware:[historyApiFallback()]})}),gulp.task("default",["clean"],function(e){runSequence(["ensureFiles","copy","styles"],"lbclient",["images","fonts","html"],"vulcanize",e)}),gulp.task("build-deploy-gh-pages",function(e){runSequence("default","deploy-gh-pages",e)}),gulp.task("deploy-gh-pages",function(){return gulp.src(dist("**/*")).pipe($["if"]("true"===process.env.TRAVIS,$.ghPages({remoteUrl:"https://$GH_TOKEN@github.com/polymerelements/polymer-starter-kit.git",silent:!0,branch:"gh-pages"}),$.ghPages()))}),require("web-component-tester").gulp.init(gulp);try{require("require-dir")("tasks")}catch(err){console.error(err)}